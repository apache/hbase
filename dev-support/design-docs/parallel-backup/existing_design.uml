@startuml
start
: (1.1) Create Backup;
if ( hasActiveSession or inInconsistentState?) then (yes)
  : Fail;
  stop
else (no)
  : (1.2.1) Create Backup Request and execute;
  : (1.2.2) Create dirs in destination;
  : (1.2.3) Create Backup Client and execute;
  : (1.2.4) Create exclusive backup session;
  : (1.2.5) Take Backup Table Snapshot;
  : (1.2.6) Set State to RUNNING and phase to REQUEST;
  if ( full backup?) then (yes)
    : (1.2.7.1.1) Read last backup start time or 0L;
    : (1.2.7.1.2) Perform LogRoll Procedure;
    : (1.2.7.1.3) Record WAL older than LogRoll to system table;
    : (1.2.7.1.4) Set Phase to SNAPSHOT;
    : (1.2.7.1.5) Take Snapshot of every table;
    : (1.2.7.1.6) Export Snapshot to dest dir;
    : (1.2.7.1.7) Write start time for next backup to system table;
    : (1.2.7.1.8) Add Manifest;
    : (1.2.7.1.9) Delete Snapshots;
    : (1.2.7.1.10) Cleanup Export snapshot log;
  else (no)
    : (1.2.7.2.1) Set phase to PREPARE_INCREMENTAL;
    if (fail to get log file map?) then (yes)
      : Fail;
      stop
    else (no)
      : (1.2.7.2.2) Copy table and region info;
      : (1.2.7.2.3) MR to convert WAL into HFiles;
      : (1.2.7.2.4) Copy HFiles into dest with DistCP
      : (1.2.7.2.5) Record WAL older than what is copied;
      : (1.2.7.2.6) Write start time for next backup to system table;
      : (1.2.7.2.7) Add Manifest;
      : (1.2.7.2.8) Cleanup DistCp log;
    endif
  endif
  : (1.2.8) Delete System Table Snapshot;
  : (1.2.9) Update BackupInfo with Status Complete;
  : (1.2.10) Clear exclusive backup sesion;
endif
stop

start
: Fail;
: (2.1) Set State to FAILED;
if (full backup?) then (yes)
  : (2.2.1.1) Delete all snapshots;
  : (2.2.1.2)Cleanup export snapshot log;
endif
: (2.3) Restore backup system table from snapshot;
: (2.4) Delete backup system table snapshot;
: (2.5) Cleanup Target Dir;
stop
@enduml
